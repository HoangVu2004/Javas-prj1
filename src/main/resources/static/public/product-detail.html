<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Detail</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/kit.css">
</head>
<body>
    <header>
        <h1>Product Detail</h1>
        <nav>
            <ul>
                <li><a href="/index.html">Home</a></li>
                <li><a href="/public/products.html">Products</a></li>
                <li><a href="/public/cart.html">Cart</a></li>
                <li><a href="/auth/login.html">Login</a></li>
            </ul>
        </nav>
    </header>

    <main class="product-detail-container">
        <section class="product-image">
            <img id="kit-image" src="" alt="Kit Image">
        </section>
        <section class="product-info">
            <h2 id="kit-name"></h2>
            <p><strong>Price:</strong> $<span id="kit-price"></span></p>
            <p><strong>Description:</strong> <span id="kit-description"></span></p>
            <p><strong>Stock Quantity:</strong> <span id="kit-stock-quantity"></span></p>
            <p><strong>Difficulty Level:</strong> <span id="kit-difficulty-level"></span></p>
            <p><strong>Age Range:</strong> <span id="kit-age-range"></span></p>
            <div class="quantity-selector">
                <label for="quantity">Quantity:</label>
                <input type="number" id="quantity" name="quantity" value="1" min="1">
            </div>
            <button id="add-to-cart-btn">Add to Cart</button>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 STEM Kit Lab</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const kitId = urlParams.get('id');

            if (kitId) {
                fetch(`/api/kits/${kitId}`)
                    .then(response => response.json())
                    .then(kit => {
                        document.getElementById('kit-image').src = kit.imageUrl;
                        document.getElementById('kit-name').textContent = kit.name;
                        document.getElementById('kit-price').textContent = kit.price;
                        document.getElementById('kit-description').textContent = kit.description;
                        document.getElementById('kit-stock-quantity').textContent = kit.stockQuantity;
                        document.getElementById('kit-difficulty-level').textContent = kit.difficultyLevel;
                        document.getElementById('kit-age-range').textContent = kit.ageRange;
                    })
                    .catch(error => console.error('Error fetching kit details:', error));
            } else {
                console.error('No kit ID found in URL');
            }

            document.getElementById('add-to-cart-btn').addEventListener('click', () => {
                const quantity = document.getElementById('quantity').value;
                if (kitId && quantity) {
                    fetch('/api/cart/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ productId: kitId, quantity: parseInt(quantity) }),
                    })
                    .then(response => {
                        if (response.status === 401 || response.status === 403) {
                            alert('Please log in to add items to your cart.');
                            window.location.href = '/auth/login.html';
                            return;
                        }
                        if (!response.ok) {
                            throw new Error('Failed to add item to cart');
                        }
                        return response.text(); // Use text() as the success response is a plain string
                    })
                    .then(data => {
                        alert('Item added to cart successfully!');
                        // Optionally update cart count in header or redirect to cart page
                        // window.location.href = '/public/cart.html';
                    })
                    .catch(error => {
                        console.error('Error adding item to cart:', error);
                        alert('Error adding item to cart. Please try again.');
                    });
                } else {
                    alert('Please select a quantity and ensure product details are loaded.');
                }
            });
        });
    </script>
</body>
</html>