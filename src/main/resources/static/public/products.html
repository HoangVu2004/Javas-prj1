<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/kit.css">
</head>
<body>
    <header>
        <h1>Our Products</h1>
        <nav>
            <ul>
                <li><a href="/index.html">Home</a></li>
                <li><a href="/public/products.html">Products</a></li>
                <li><a href="/public/cart.html">Cart</a></li>
                <li><a href="/auth/login.html">Login</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <section class="sorting-controls">
            <div>
                <label for="sort-by-age">Age:</label>
                <select id="sort-by-age">
                    <option value="none">None</option>
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
            </div>
            <div>
                <label for="sort-by-rating">Rating:</label>
                <select id="sort-by-rating">
                    <option value="none">None</option>
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
            </div>
            <div>
                <label for="sort-by-difficulty">Difficulty:</label>
                <select id="sort-by-difficulty">
                    <option value="none">None</option>
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
            </div>
            <div>
                <label for="sort-by-price">Price:</label>
                <select id="sort-by-price">
                    <option value="none">None</option>
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
            </div>
            <button id="apply-sort-btn">Apply Sort</button>
        </section>

        <section class="product-listing-container" id="product-list">
            <!-- Product cards will be loaded here by JavaScript -->
        </section>
    </main>

    <footer>
        <p>&copy; 2025 STEM Kit Lab</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const productListContainer = document.getElementById('product-list');
            const sortAgeSelect = document.getElementById('sort-by-age');
            const sortRatingSelect = document.getElementById('sort-by-rating');
            const sortDifficultySelect = document.getElementById('sort-by-difficulty');
            const sortPriceSelect = document.getElementById('sort-by-price');
            const applySortBtn = document.getElementById('apply-sort-btn');

            let products = []; // To store fetched product data

            // Function to fetch products from the API
            function fetchProducts() {
                fetch('/api/kits') // Assuming your API endpoint for kits is /api/kits
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        products = data;
                        renderProducts(products);
                    })
                    .catch(error => {
                        console.error('Error fetching products:', error);
                        productListContainer.innerHTML = '<p>Error loading products. Please try again later.</p>';
                    });
            }

            // Format price to Vietnamese Dong
            const formatPrice = (price) => {
                // Ensure price is a number before formatting
                const numericPrice = typeof price === 'number' ? price : parseFloat(price) || 0;
                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(numericPrice);
            };

            // Function to render products to the DOM
            function renderProducts(productsToRender) {
                productListContainer.innerHTML = ''; // Clear existing products
                if (productsToRender.length === 0) {
                    productListContainer.innerHTML = '<p>No products found.</p>';
                    return;
                }
                productsToRender.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.classList.add('product-card');
                    productCard.innerHTML = `
                        <img src="${product.imageUrl || '../images/placeholder.png'}" alt="${product.name}">
                        <h3>${product.name}</h3>
                        <p class="price">$${product.price.toFixed(2)}</p>
                        <div class="details">
                            <span>Difficulty: ${product.difficultyLevel}</span>
                            <span>Age: ${product.ageRange}</span>
                        </div>
                        <p class="rating">Rating: ${product.rating || 'N/A'}</p>
                        <div class="actions">
                            <a href="product-detail.html?id=${product.id}" class="btn-details">View Details</a>
                        </div>
                    `;
                    productListContainer.appendChild(productCard);
                });
            }


                // Function to sort products
                function sortProducts() {
                    const sortByAge = sortAgeSelect.value;
                    const sortByRating = sortRatingSelect.value;
                    const sortByDifficulty = sortDifficultySelect.value;
                    const sortByPrice = sortPriceSelect.value;
    
                    let sortedProducts = [...products]; // Create a copy
    
                    // Determine the primary sort criterion based on priority
                    let sortApplied = false;
    
                    if (sortByPrice !== 'none') {
                        sortedProducts.sort((a, b) => {
                            if (sortByPrice === 'asc') return a.price - b.price;
                            return b.price - a.price;
                        });
                        sortApplied = true;
                    } else if (sortByDifficulty !== 'none') {
                        sortedProducts.sort((a, b) => {
                            const difficultyMap = { 'Easy': 1, 'Medium': 2, 'Hard': 3 };
                            const diffA = difficultyMap[a.difficultyLevel] || 0;
                            const diffB = difficultyMap[b.difficultyLevel] || 0;
                            if (sortByDifficulty === 'asc') return diffA - diffB;
                            return diffB - diffA;
                        });
                        sortApplied = true;
                    } else if (sortByRating !== 'none') {
                        sortedProducts.sort((a, b) => {
                            const ratingA = a.rating || 0;
                            const ratingB = b.rating || 0;
                            if (sortByRating === 'asc') return ratingA - ratingB;
                            return ratingB - ratingA;
                        });
                        sortApplied = true;
                    } else if (sortByAge !== 'none') {
                        sortedProducts.sort((a, b) => {
                            const getAgeNumber = (ageStr) => {
                                if (!ageStr) return 0;
                                const parts = ageStr.split('-');
                                return parseInt(parts[0], 10);
                            };
                            const ageA = getAgeNumber(a.ageRange);
                            const ageB = getAgeNumber(b.ageRange);
                            if (sortByAge === 'asc') return ageA - ageB;
                            return ageB - ageA;
                        });
                        sortApplied = true;
                    }
    
                    // If no sort was applied (all are 'none'), render original products
                    if (!sortApplied) {
                        sortedProducts = products;
                    }
    
                    renderProducts(sortedProducts);
                }
    
                // Event listeners for sort select elements
                sortAgeSelect.addEventListener('change', sortProducts);
                sortRatingSelect.addEventListener('change', sortProducts);
                sortDifficultySelect.addEventListener('change', sortProducts);
                sortPriceSelect.addEventListener('change', sortProducts);
    
                // Event listener for the sort button
                applySortBtn.addEventListener('click', sortProducts);
    
                // Initial fetch and render of products
                fetchProducts();
            });
        </script>
</body>
</html>