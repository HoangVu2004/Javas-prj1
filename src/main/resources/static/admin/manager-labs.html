<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Labs</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Manager Panel</h3>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="manager-dashboard.html">Dashboard</a></li>
                    <li><a href="manager-users.html">Manage Users</a></li>
                    <li><a href="manager-kits.html">Manage Kits</a></li>
                    <li><a href="manager-labs.html" class="active">Manage Labs</a></li>
                    <li><a href="manager-orders.html">Manage Orders</a></li>
                    <li><a href="manager-reports.html">Reports</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="#" id="logoutButton" class="btn btn-logout">Logout</a>
            </div>
        </aside>
        <main class="main-content">
            <header class="main-header">
                <h1>Manage Labs</h1>
                <button class="btn" onclick="openCreateModal()">Create New Lab</button>
            </header>
            <section class="content-area">
                <div id="lab-list" class="card">
                    <!-- Lab list will be loaded here -->
                </div>
            </section>
        </main>
    </div>

    <!-- The Modal -->
    <div id="labModal" class="modal">
        <div class="modal-content card">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modal-title">Create Lab</h2>
            <form id="labForm">
                <input type="hidden" id="labId">
                <label for="labTitle">Title:</label>
                <input type="text" id="labTitle" name="title" required>
                <label for="labDescription">Description:</label>
                <textarea id="labDescription" name="description" required></textarea>
                <label for="labContent">Content:</label>
                <textarea id="labContent" name="content" rows="10" required></textarea>
                <button type="submit" class="btn">Save</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/auth/login.html';
                return;
            }
            document.getElementById('logoutButton').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('token');
                window.location.href = '/auth/login.html';
            });

            fetchLabs();
            document.getElementById('labForm').addEventListener('submit', handleFormSubmit);
        });

        const modal = document.getElementById('labModal');
        const form = document.getElementById('labForm');
        const labListDiv = document.getElementById('lab-list');

        function openCreateModal() {
            form.reset();
            document.getElementById('labId').value = '';
            document.getElementById('modal-title').innerText = 'Create Lab';
            modal.style.display = 'block';
        }

        function openEditModal(lab) {
            form.reset();
            document.getElementById('labId').value = lab.id;
            document.getElementById('labTitle').value = lab.title;
            document.getElementById('labDescription').value = lab.description;
            document.getElementById('labContent').value = lab.content;
            document.getElementById('modal-title').innerText = 'Edit Lab';
            modal.style.display = 'block';
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        async function fetchLabs() {
            try {
                const response = await fetch('/api/labs', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (response.status === 401 || response.status === 403) {
                     window.location.href = '/auth/login.html';
                     return;
                }
                if (!response.ok) throw new Error('Failed to fetch labs.');
                
                const data = await response.json();
                // Assuming the API returns an object with a 'content' array
                const labs = data.content || [];
                renderLabs(labs);
            } catch (error) {
                console.error('Error:', error);
                labListDiv.innerHTML = `<p>${error.message}</p>`;
            }
        }

        function renderLabs(labs) {
            labListDiv.innerHTML = '';
            if (!labs || labs.length === 0) {
                labListDiv.innerHTML = '<p>No labs available.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            const tbody = table.querySelector('tbody');
            labs.forEach(lab => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${lab.title}</td>
                    <td>${lab.description}</td>
                    <td class="actions">
                        <button class="btn btn-edit" onclick='openEditModal(${JSON.stringify(lab)})'>Edit</button>
                        <button class="btn btn-delete" onclick="deleteLab(${lab.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            labListDiv.appendChild(table);
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const labId = document.getElementById('labId').value;
            const labData = {
                title: document.getElementById('labTitle').value,
                description: document.getElementById('labDescription').value,
                content: document.getElementById('labContent').value
            };

            const method = labId ? 'PUT' : 'POST';
            const url = labId ? `/api/labs/${labId}` : '/api/labs';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(labData)
                });

                if (!response.ok) throw new Error(`Failed to ${labId ? 'update' : 'create'} lab.`);
                
                closeModal();
                fetchLabs();
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

        async function deleteLab(labId) {
            if (!confirm('Are you sure you want to delete this lab?')) return;
            
            try {
                const response = await fetch(`/api/labs/${labId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (!response.ok) throw new Error('Failed to delete lab.');
                
                fetchLabs();
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }
    </script>
</body>
</html>