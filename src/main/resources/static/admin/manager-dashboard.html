<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Manager Panel</h3>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="manager-dashboard.html" class="active">Dashboard</a></li>
                    <li><a href="manager-users.html">Manage Users</a></li>
                    <li><a href="manager-kits.html">Manage Kits</a></li>
                    <li><a href="manager-labs.html">Manage Labs</a></li>
                    <li><a href="manager-orders.html">Manage Orders</a></li>
                    <li><a href="manager-reports.html">Reports</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="#" id="logoutButton" class="btn btn-logout">Logout</a>
            </div>
        </aside>
        <main class="main-content">
            <header class="main-header">
                <h1>Dashboard Overview</h1>
                <div class="user-info">
                    <span>Welcome, <strong id="username">Manager</strong>!</span>
                </div>
            </header>
            <section class="stats-cards">
                <div class="card">
                    <h4>Total Users</h4>
                    <p id="total-users">Loading...</p>
                </div>
                <div class="card">
                    <h4>Total Kits</h4>
                    <p id="total-kits">Loading...</p>
                </div>
                <div class="card">
                    <h4>Total Orders</h4>
                    <p id="total-orders">Loading...</p>
                </div>
                <div class="card">
                    <h4>Revenue</h4>
                    <p id="revenue">Loading...</p>
                </div>
            </section>
            <section class="recent-activity">
                <h2>Recent Activity</h2>
                <div id="activity-feed" class="card">
                    <!-- Dynamic content will be loaded here -->
                    <p>No recent activity.</p>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/auth/login.html';
                return;
            }

            // Decode JWT to get user info (simplified)
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                document.getElementById('username').textContent = payload.sub; // 'sub' is typically the username
            } catch (e) {
                console.error('Failed to decode token:', e);
            }

            document.getElementById('logoutButton').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('token');
                window.location.href = '/auth/login.html';
            });

            // Fetch dashboard data from APIs
            function fetchDashboardData() {
                fetch('/api/users')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data) {
                            document.getElementById('total-users').textContent = data.data.length;
                        } else {
                            document.getElementById('total-users').textContent = 'Error';
                            console.error('Failed to fetch total users:', data.message);
                        }
                    })
                    .catch(error => {
                        document.getElementById('total-users').textContent = 'Error';
                        console.error('Error fetching total users:', error);
                    });

                fetch('/api/kits')
                    .then(response => response.json())
                    .then(data => {
                        if (data) { // Assuming /api/kits returns an array directly
                            document.getElementById('total-kits').textContent = data.length;
                        } else {
                            document.getElementById('total-kits').textContent = 'Error';
                            console.error('Failed to fetch total kits:', data);
                        }
                    })
                    .catch(error => {
                        document.getElementById('total-kits').textContent = 'Error';
                        console.error('Error fetching total kits:', error);
                    });

                // Fetch and display mock order data for total orders and revenue
                // This data is simulated as per user's request to avoid backend modification.
                const mockOrders = [
                    { id: 1, customer: 'John Doe', date: '2023-01-01', total: 100, status: 'Shipped' },
                    { id: 2, customer: 'Jane Smith', date: '2023-01-05', total: 200, status: 'Pending' },
                    { id: 3, customer: 'David Lee', date: '2023-01-10', total: 150, status: 'Delivered' }
                ];

                const totalOrders = mockOrders.length;
                const totalRevenue = mockOrders.reduce((sum, order) => sum + order.total, 0);

                document.getElementById('total-orders').textContent = totalOrders;
                document.getElementById('revenue').textContent = `$${totalRevenue.toFixed(2)}`;
            }

            fetchDashboardData();
        });
    </script>
</body>
</html>